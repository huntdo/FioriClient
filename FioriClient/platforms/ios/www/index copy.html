<html>
    <head>
        <script src="datajs-1.1.2.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
        <script type="text/javascript" charset="utf-8" src="appConfig.js"></script>
        <script>
            applicationContext = null;
            
            window.onerror = onError;
            
            var appId = appConfig.appId; // Change this to app id on server
            
            // Optional initial connection context
            var context = {
                "serverHost": "54.183.169.52", //Place your SMP 3.0 server name here
                "https": "false",
                "serverPort": "8080",
                "user": "MyUserName", //For demo purposes, specify the user name you wish to register with here to save typing on the device 
                "password": "MyPassword",  //Note, if you wish to use this user name and password to be passed to the backend OData producer, choose Basic as the SSO mechanism
                                      //The read method is sending the user name and password in an Authorization header with each request
                                      //Alternatively the AuthProxy plugin can respond to 401 challenges automatically when SAPKapselHandleHttpRequests=true 
                                      //once set can be changed by calling sap.Logon.changePassword()
                "communicatorId": "REST",
                "passcode": "password",  //note hardcoding passwords and unlock passcodes are strictly for ease of use during development
                                         //once set can be changed by calling sap.Logon.managePasscode()
                "unlockPasscode": "password",
                "passcode_CONFIRM":"password",
                "ssoPasscode":"Password1"
            };

            function onError(msg, url, line) {
                var idx = url.lastIndexOf("/");
                var file = "unknown";
                if (idx > -1) {
                    file = url.substring(idx + 1);
                }
                alert("An error occurred in " + file + " (at line # " + line + "): " + msg);
                return false; //suppressErrorAlert;
            }
            
            function init() {
                if (sap.Logger) {
                    sap.Logger.setLogLevel(sap.Logger.DEBUG);  //enables the display of debug log messages from the Kapsel plugins.
                    sap.Logger.debug("Log level set to DEBUG");
                }
                
                sap.Logon.init(logonSuccessCallback, logonErrorCallback, appId, context);
                console.log("init completed");
            }
            
            function logonSuccessCallback(result) {
                console.log("logonSuccessCallback " + JSON.stringify(result));
                applicationContext = result;
               
               alert("register successful");
               showScreen("MainDiv");
            }

            function logonErrorCallback(error) {   //this method is called if the user cancels the registration.
                console.log("An error occurred:  " + JSON.stringify(error));
                if (device.platform == "Android") {  //Not supported on iOS
                    navigator.app.exitApp();
                }
            }
        
            function read() {
                if (!applicationContext) {
                    alert("Register or unlock before proceeding");
                    return;
                }
                clearTable();
                sUrl = applicationContext.applicationEndpointURL + "/CarrierCollection?$format=json";  //JSON format is less verbose than atom/xml
                var oHeaders = {};
                //this can be provided by the authproxy plugin if intercept all requests is set to true.  It is by default on iOS but not on Android
                oHeaders['Authorization'] = "Basic " + btoa(applicationContext.registrationContext.user + ":" + applicationContext.registrationContext.password);
                //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;  //not needed as this will be sent by the logon plugin
                
                var request = {
                    headers : oHeaders,
                    requestUri : sUrl,
                    method : "GET"
                };
                OData.read(request, readSuccessCallback, errorCallback);
            }
            
            function readSuccessCallback(data, response) {
                var carrierTable = document.getElementById("carrierTable");
                
                for (var i = data.results.length -1; i >= 0; i--) {
                    var row = carrierTable.insertRow(1);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    cell1.innerHTML = data.results[i].carrid;
                    cell2.innerHTML = data.results[i].CARRNAME;
                }
            }
            
            function clearTable() {
                var carrierTable = document.getElementById("carrierTable");
                while(carrierTable.rows.length > 1) {
                    carrierTable.deleteRow(1);
                }
            }
            
            function errorCallback(e) {
                alert("An error occurred: " + JSON.stringify(e));
                showScreen("MainDiv");
            }
            
            function register() {
                sap.Logon.init(logonSuccessCallback, logonErrorCallback, appId, context);
            }
            
            function unRegister() {
                sap.Logon.core.deleteRegistration(logonUnregisterSuccessCallback, errorCallback);
                clearTable();
            }

            function logonUnregisterSuccessCallback(result) {
                alert("Successfully Unregistered");
                console.log("logonUnregisterSuccessCallback " + JSON.stringify(result));
                applicationContext = null;
            }
            
            function lock() {
                sap.Logon.lock(logonLockSuccessCallback, errorCallback);
                clearTable();
            }

            function logonLockSuccessCallback(result) {
                console.log("logonLockSuccessCallback " + JSON.stringify(result));
                applicationContext = null;
                showScreen("LockedDiv");  //sap.Logon.unlock(function () {},function (error) {});  //alternatively show the unlock screen
            }

            function unlock() {
                sap.Logon.unlock(logonSuccessCallback, errorCallback);
            }
            
            function showScreen(screenIDToShow) {
                var screenToShow = document.getElementById(screenIDToShow);
                screenToShow.style.display = "block";
                var screens = document.getElementsByClassName('screenDiv');
                for (var i = 0; i < screens.length; i++) {
                    if (screens[i].id != screenToShow.id) {
                        screens[i].style.display = "none";
                    }
                }
            }
            
            document.addEventListener("deviceready", init, false);
            
            </script>
        
    </head>
    <body>
        <div class="screenDiv" id="LoadingDiv">
            <h1>Loading ...</h1>
        </div>
        
        <div class="screenDiv" id="LockedDiv" style="display: none">
            <h1>Locked</h1>
            <button id="unlock" onclick="unlock()">Unlock</button>
        </div>
        
        <div class="screenDiv" id="MainDiv" style="display: none">
            <h1>Logon Sample 3</h1>
            <button id="register" onclick="register()">Register</button>
            <button id="read" onclick="read()">Read</button>
            <button id="unregister" onclick="unRegister()">Unregister</button>
            <button id="lock" onclick="lock()">Lock</button>
            <button id="unlock" onclick="unlock()">Unlock</button>
            <table id="carrierTable"><tr><th>Carrier ID</th><th>Carrier Name</th></tr></table>
        </div>
    </body>
</html>


